## Harmonic Analysis documentation

The harmonic analysis developed in this project is based on two basic principles: The key recognition and the chord recognition including non-chord tones.

### Key recognition

The so-called Krumhansl-Schmuckler algorithm, which is used in music information retrieval and in programs such as [Humdrum](http://extras.humdrum.org/man/keycor/) or [music21](http://web.mit.edu/music21/doc/moduleReference/moduleAnalysisDiscrete.html), was used for key recognition. It can be used to examine segments of different sizes for their key, so that modulations could be recognizable. The algorithm is based on the principle of counting the sounding pitches. The resulting numerical values are compared with reference values derived from listening experiments or corpora. These reference values indicate that a certain distribution of tones is best suited to a certain key. The reference values of our data are compared with all the referenced ones of all keys and the "best, that is, highest correlation, is the key of this segment. Since there are several experiments and corpora with reference values, there are also several results that differ slightly. These five profiles can be selected in the viewer. In addition, there is a "mixed" profile, which was determined from the mean value of all profiles.

The user can select segments that are measure-based. If the user selects a segment to be examined that is smaller than the total number of measures of the piece, this number of measures is analyzed overlapping. For example, if a segment of 4 measures is selected, measures 1-4 are counted and analyzed, followed by measures 2-5, and so on. This may result in several interpretations of the measure depending on its context. The Viewer displays colored bars for each key, which overlap at these ambiguous measures. In this way possible modulations can be recognized.

### Chord recognition

The harmonic analysis needs also a chord recognition. In order to determine the chords, the simultaneously sounding notes are examined at a certain time (here: every time stamp). Then these tones are nested into intervals consisting of thirds. In most cases, the densest nesting of thirds is decisive for a chord. In XSLT every third above the fundamental is counted up, so the first third above C, the E, gets the number 1, the G gets the number 2 and so on. Then thirds can be built over each sounding tone. The lowest number of all highest thirds then determines over which note the chord is probably built. Sometimes there are also two equal interpretations of a chord, then both interpretations are written into the data. 

Non-chord tones "disturb" this view of harmony. But since they only "decorate" the harmonies or create tension and often do not create harmony changes, they should be filtered out of the harmony recognition or should be read and evaluated as the "actual" chord tone. These non-chord tones often have a function and are subject to certain rules. Simple suspension rules were relatively easy to implement: The dissonant note must lie on an accentuated, heavy counting time, it must dissolve downwards into the corresponding chord note, for example from a fourth to a third, i.e. step by step (seconds). The fundamental must not change, i.e. must be longer or repeat itself, whereby octave pendulums are permitted. If these conditions apply to a note, the script changes the dissonant interpretation into the interpretation of the note into which it dissolves. Thus, as is analytically correct, the counting times are not viewed in isolation, but the melodic, horizontal component is included.

For the melodic approach the voice leading is important. In order to find out which note follows which note, the attributes `@next` and `@pref` with the `xml:id` of the respective note were added to each note in advance. In addition, the respective interval for the following note is calculated and added to each note with the `@intm` attribute.

In combination with the recognized key information, the recognized chords can now be transposed to Roman Numerals. Nevertheless, in some places there are several interpretations that are equally possible, and the script cannot "decide" which interpretation of a chord is more likely. Therefore, it should be checked which chord follows, i.e. the context is now looked at. The chord sequences should be viewed from the end. If one of the interpretations has the same level as the following chord and even has suspensions that result in this chord, then it is very likely that this is the correct or most logical interpretation. Furthermore, more chord sequences can be described that are more likely than others. First, of course, whether the step is the same. Then, whether a V or an IV comes before an I; if an IV or an I comes before a V etc. For this, bonus points are distributed to these chords which influence the interpretation. If there is only one interpretation (as in most places), this interpretation will be used. So, a "wrong" interpretation does not influence the analysis of the whole piece. 

